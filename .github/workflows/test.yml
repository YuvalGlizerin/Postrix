# Run all tests for all services/packages
name: Tests

on:
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - uses: ./.github/actions/repo-warm-up

      - name: Use Node.js 22.x
        uses: actions/setup-node@v4
        with:
          node-version: '22.x'

      - run: npm ci && npm ci --prefix services/joby
      - name: Run Jest Test Suite
        run: npm test
        env:
          CI: true

      - name: Upload Test Report Artifact
        uses: actions/upload-artifact@v4
        with:
          name: test-report
          path: coverage/lcov-report/index.html

      - name: Generate Coverage Report
        id: coverage
        run: |
          COVERAGE=$(cat coverage/coverage-summary.json | jq -r '.total.lines.pct')
          SUMMARY=$(cat coverage/coverage-summary.json | jq -r '
            "| Category | Coverage |\n" +
            "|----------|----------|\n" +
            "| Lines | \(.total.lines.pct)% |\n" +
            "| Statements | \(.total.statements.pct)% |\n" +
            "| Functions | \(.total.functions.pct)% |\n" +
            "| Branches | \(.total.branches.pct)% |"
          ')
          echo "coverage=$COVERAGE" >> $GITHUB_OUTPUT
          echo "summary<<EOF" >> $GITHUB_OUTPUT
          echo "$SUMMARY" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Deploy Coverage Report to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./coverage/lcov-report

      - name: Comment PR
        uses: ./.github/actions/comment-pr
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          title: "Test Coverage Report"
          block: |
            Coverage: ${{ steps.coverage.outputs.coverage }}%
          message: |
            ${{ steps.coverage.outputs.summary }}

            **Test Report:** [View details here](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
            **Coverage Report:** [View Report](https://<YOUR_GITHUB_USERNAME>.github.io/<YOUR_REPOSITORY>/coverage/lcov-report/index.html)
